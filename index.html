<!DOCTYPE html>
<html lang="et">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta property="og:url" content="https://mnemosyne.ee/kirmus4" />
    <meta property="og:title" content="KirMus · 4" />
    <!-- <meta property="og:image" content="/assets/images/bg/andmebaas.jpg" /> -->
    <title>Baas · </title>
    <link href="https://cloud.typography.com/6935656/6118392/css/fonts.css" rel="stylesheet" type="text/css" />
    <link href="./assets/bootstrap.css" rel="stylesheet" />
    <link href="./style.css" rel="stylesheet" />
</head>

<body>
    <div class="col-12" id="search">
        <h3 class="mb-3">Otsing</h3>
        <form class="form" id="searchform" action="/" method="GET">
            <input class="col-8 col-md-6 col-xl-4" type="search" name="q" placeholder="sisesta nimi →" />
            <button class="col-4 col-md-3 col-xl-2">Otsi</button>
        </form>
        <p class="mt-2 mb-4" id="search-count"></p>
        <div id="search-results"></div>
    </div>
    <div class="d-none" id="popup-background"></div>
    <div class="p-3 d-none" id="popup-content">
        <div class="row">
            <h2 class="col-12" id="db-feedback-title">Tagasiside %name% kohta</h2>
            <div class="col-12 col-md-10 offset-md-1" id="db-feedback-text">
                <p>
                    Kui Teie poolt pakutud muudatus puudutab persooni põhiandmeid - nimi
                    või sünni- ning surmaaasta - saatke õigeid andmeid kinnitav dokument
                    aadressile memoriaal@mnemosyne.ee
                </p>
            </div>
            <form class="col-12 col-md-8 offset-md-2" id="db-feedback" method="POST" name="db-feedback">
                <input type="hidden" name="form-name" value="db-feedback" />
                <input id="db-feedback-id" type="hidden" name="id" />
                <input id="db-feedback-url" type="hidden" name="url" />
                <input id="db-feedback-name" type="hidden" name="name" />
                <input class="d-none" id="db-feedback-fax" type="tel" name="fax" />
                <div class="form-group mt-5">
                    <label class="form-label col-12 px-0" for="db-feedback-email">Kontakt e-post</label><input
                        class="col-12 px-0" id="db-feedback-email" type="email" name="contact-email" />
                </div>
                <div class="form-group mt-5">
                    <label class="form-label col-12 px-0" for="db-feedback-phone">Kontakt telefon</label><input
                        class="col-12 px-0" id="db-feedback-phone" type="tel" name="contact-phone" />
                </div>
                <div class="form-group mt-5">
                    <label class="form-label col-12 px-0" for="db-feedback-feedback">Tagasiside</label><textarea
                        class="col-12 px-0" id="db-feedback-feedback" name="feedback" rows="5"></textarea>
                </div>
                <div class="form-group mt-5 text-right">
                    <button class="btn btn-secondary" id="db-feedback-cancel">
                        Tühista</button><button class="btn btn-primary ml-3" id="db-feedback-submit" type="submit">
                        Saada tagasiside
                    </button>
                </div>
            </form>
            <h2 class="col-12 d-none" id="db-feedback-success">
                Täname tagasiside eest
            </h2>
        </div>
    </div>
    <script src="./assets/jquery-3.3.1.min.js"></script>
    <script src="./script.js"></script>
    <script src="./functions/search.js"></script>
    <script>
        $(function () {
            var qs = function (key) {
                key = key.replace(/[*+?^$.\[\]{}()|\\\/]/g, "\\$&")
                var match = location.search.match(new RegExp("[?&]"+key+"=([^&]+)(&|$)"))
                return match && decodeURIComponent(match[1].replace(/\+/g, " "))
            }

            var query = qs('q')
            var filter = qs('f') || 'all'
            var idQuery = (query == Number(query) && query.length === 10)

            $('input[value="'+filter+'"]').prop('checked', true)

            if (query) {
                $('input[name="q"]').val(query)

                var qData = {
                    query : {
                        bool : {
                            must : {
                                multi_match : {
                                    query: query,
                                    fields: ["perenimi", "eesnimi", "sünd", "id"],
                                    operator: 'and',
                                    type: 'cross_fields'
                                }
                            },
                            filter : { term: { relevantne: '1' } }
                        }
                    },
                    sort: { 'eesnimi.raw': 'asc', 'perenimi.raw': 'asc' },
                    _source: [
                        "perenimi",
                        "eesnimi",
                        "sünd",
                        "id",
                    ]
                }

                if (idQuery) {
                    filter = 'all'
                    qData['query']['bool']['must']['multi_match']['fields'] = ['id']
                }
                if (filter === 'wall') {
                    qData['query']['bool']['filter'] = { term: { kivi: '1' } }
                } else if (filter === 'officers') {
                    qData['query']['bool']['filter'] = { term: { ohvitser: '1' } }
                }
                $.ajax('/.netlify/functions/search', {
                    data : JSON.stringify(qData),
                    contentType : 'application/json',
                    type : 'POST',
                    cache: false,
                    success: function (data) {
                        $('#search-count').html(data.hits.total + (data.hits.total === 1 ? ' #{self.result.count.one}' : ' #{self.result.count.multiple}'))

                        for (var i = 0; i < data.hits.hits.length; i++) {
                            var text = []
                            var p = data.hits.hits[i]._source

                            text.push('<div id="' + p.id + '" class="search-result pt-2 pb-4">')
                            text.push('<div class="row">')

                            text.push('<h3 class="search-result-name col-12 mb-2 mb-1">' + (p.eesnimi ? p.eesnimi : '') + ' ' + p.perenimi + '</h3>')

                            text.push('<div class="col-5 col-sm-3">')
                            if (p.sünd) { text.push('<p class="mb-0">#{self.result.born}: ' + p.sünd + '</p>') }
                            if (p.surm) { text.push('<p class="mb-0">#{self.result.dead}: ' + p.surm + '</p>') }
                            if (p.isanimi) { text.push('<p class="mb-0">#{self.result.father}: ' + p.isanimi + '</p>') }
                            if (p.emanimi) { text.push('<p class="mb-0">#{self.result.mother}: ' + p.emanimi + '</p>') }
                            text.push('<p class="mb-0"># ' + p.id + '</p>')
                            text.push('<p class="search-result-feedback mt-3" data-id="' + p.id + '" data-name="' + p.eesnimi + ' ' + p.perenimi + '">#{self.feedback.button}</p>')
                            text.push('</div>')

                            text.push('<div class="search-result-info col-7 col-sm-6">')
                            for (var ik = 0; ik < p.kirjed.length; ik++) {
                                text.push('<p class="mt-2 mb-0"><strong>' + p.kirjed[ik].allikas + ':</strong></p>')
                                if (p.kirjed[ik].kirje) { text.push('<p class="mb-1">') }
                                if (p.kirjed[ik].kirje) { text.push(p.kirjed[ik].kirje) }
                                if (p.kirjed[ik].kirje) { text.push('</p>') }
                            }
                            if (p.pereseos && p.pereseos.length > 0) {
                                for (var ip = 0; ip < p.pereseos.length; ip++) {
                                    text.push('<hr class="my-3">')
                                    text.push('<p class="my-0"><strong>' + p.pereseos[ip].nimekiri + ' (#{self.result.family}):</strong></p>')
                                    for (var ipk = 0; ipk < p.pereseos[ip].kirjed.length; ipk++) {
                                        if (p.pereseos[ip].kirjed[ipk].kirje) { text.push('<p class="mb-1">- ') }
                                        if (p.pereseos[ip].kirjed[ipk].kirje) { text.push(p.pereseos[ip].kirjed[ipk].kirje) }
                                        if (p.pereseos[ip].kirjed[ipk].kirje) { text.push('</p>') }
                                    }
                                }
                            }
                            text.push('</div>')

                            text.push('<div class="search-result-plaque col-12 col-sm-3">')
                            if (p.tahvel) { text.push('<p class="mb-0">#{self.result.plaque}:</p>') }
                            if (p.tahvel) { text.push('<p class="mb-2 plaque-info">' + p.tahvel + '</p>') }
                            if (p.tulp) { text.push('<p class="mb-2">#{self.result.col}: ' + p.tulp + ' / #{self.result.row}: ' + p.rida + '</p>') }
                            if (p.tahvlikirje) { text.push('<p class="mb-0">#{self.result.nameOnPlaque}: ' + p.tahvlikirje + '</p>') }

                            if (p.ohvitser === '1') { text.push('<hr/><p class="mb-0">#{self.result.nameOnEVOPlaque}: ' + p.evokirje + '</p>') }
                            text.push('</div>')

                            text.push('</div>')
                            text.push('</div>')

                            $('#search-results').append(text.join(''))
                        }
                    },
                    error: function( error) {
                        console.log(error)
                    }
                })
            }

            $('input[type="radio"]').on('click', function () {
                query = $('input[name="q"]').val()
                idQuery = (query == Number(query) && query.length === 10)
                if (idQuery) {
                    $('input[value="all"]').prop('checked', true)
                    return
                }
                if ($(query && $(this).prop('value')) !== filter) {
                    $('#searchform').submit()
                }
            })
            //- $('#search-results').on('mouseenter', '.search-result', function () {
            //-     $(this).find('.search-result-feedback').removeClass('d-none')
            //- })

            //- $('#search-results').on('mouseleave', '.search-result', function () {
            //-     $(this).find('.search-result-feedback').addClass('d-none')
            //- })

            $('#search-results').on('click', '.search-result-feedback', function () {
                var id = $(this).data('id')
                var name = $(this).data('name')

                $('#db-feedback-id').val(id)
                $('#db-feedback-url').val('https://www.memoriaal.ee/baas/?q=' + id + '&f=all')
                $('#db-feedback-name').val(name)
                $('#db-feedback-title').html('#{ self.feedback.title }'.replace('%name%', name))

                $('#db-feedback-title, #db-feedback-text, #db-feedback').removeClass('d-none')
                $('#db-feedback-success').addClass('d-none')
                $('#popup-background, #popup-content').removeClass('d-none')
            })

            $('#db-feedback').submit(function (e) {
                e.preventDefault()

                var $form = $(this)

                $.post($form.attr('action'), $form.serialize(), function (data) {
                    console.log(data)

                    $('#db-feedback-title, #db-feedback-text, #db-feedback').addClass('d-none')
                    $('#db-feedback-success').removeClass('d-none')

                    $('#db-feedback input, #db-feedback textarea').val('')
                    $('#db-feedback-title').html('')

                    setTimeout(function () {
                        $('#popup-background, #popup-content').addClass('d-none')
                    }, 4000)
                })
            })

            $('#db-feedback-cancel').click(function (e) {
                e.preventDefault()

                $('#db-feedback input, #db-feedback textarea').val('')
                $('#db-feedback-title').html('')

                $('#popup-background, #popup-content').addClass('d-none')
            })
        })
    </script>
</body>

</html>